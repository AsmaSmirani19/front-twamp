<div class="container-fluid">
  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-body table-responsive">
          <table class="table table-hover" *ngIf="testResults && testResults.length > 0">
            <thead>
              <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Status</th>
                <th>Agent</th>
                <th>Action</th>
              </tr>
            </thead>
           <tbody>
            <tr *ngFor="let result of testResults; trackBy: trackByTestTargetId">
              <td>{{ result.testName }}</td>
              <td>{{ result.testType }}</td>
              <td>
                <span class="tag" [ngClass]="getStatusClass(result.status)">
                  {{ result.status }}
                </span>
              </td>
              <td>{{ result.sourceAgent }}</td>
              <td>
                <i class="fa fa-eye text-info me-2" (click)="onView(result)" style="cursor:pointer;"></i>
                <i class="fa fa-trash text-danger" (click)="onDelete(result)" style="cursor:pointer;"></i>
              </td>
            </tr>
          </tbody>

          </table>
          <div *ngIf="!testResults || testResults.length === 0" class="text-center text-muted">No results found.</div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Popup styled like Pinterest -->
<div class="pinterest-popup-overlay" *ngIf="selectedResult">
  <div class="pinterest-popup-card">

    <!-- Header -->
    <div class="popup-header">
      <h4>{{ selectedResult.testName }}</h4>
      <button class="close-btn" aria-label="Close" (click)="closePopup()">&times;</button>
    </div>

    <!-- Body -->
    <div class="popup-body">

      <!-- ðŸŸ¦ Test Info (pleine largeur) -->
      <div class="test-info full-width">
        <p><strong>Status:</strong>
          <span [ngClass]="getStatusClass(selectedResult.status)">
            {{ selectedResult.status }}
          </span>
        </p>
        <p><strong>Creation Date:</strong> {{ selectedResult.creationDate | date: 'medium' }}</p>
        <p><strong>Duration:</strong> {{ selectedResult.testDuration }}</p>
        <p><strong>Source Agent:</strong> {{ selectedResult.sourceAgent }}</p>
        <p><strong>Target Agent:</strong> {{ selectedResult.targetAgent }}</p>
        <p><strong>Threshold Name:</strong> {{ selectedResult.thresholdName }}</p>
        <p><strong>Threshold Value:</strong> {{ selectedResult.thresholdValue }}</p>
      </div>

      <!-- ðŸŸ© Tableau mÃ©triques QoS PAR TARGET -->
    <table class="simple-metrics-table" *ngIf="qosResultsMap[selectedResult.test_id]?.length">
      <thead>
        <tr>
          <th>Target ID</th>
          <th>Avg Latency (ms)</th>
          <th>Avg Jitter (ms)</th>
          <th>Avg Throughput (kbps)</th>
          <th>Packet Loss (%)</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let qos of qosResultsMap[selectedResult.test_id]">
          <td>{{ qos.target_id }}</td>
          <td>{{ qos.avg_latency_ms | number:'1.1-2' }}</td>
          <td>{{ qos.avg_jitter_ms | number:'1.1-2' }}</td>
          <td>{{ qos.avg_throughput_kbps | number:'1.1-2' }}</td>
          <td>{{ qos.packet_loss_percent | number:'1.1-2' }}</td>
        </tr>
      </tbody>
    </table>


  <!-- ðŸŸ¥ Si pas de donnÃ©es -->
  <div class="no-data-message" *ngIf="!qosResultsMap[selectedResult.test_id]?.length">
    Aucune donnÃ©e QoS disponible pour ce test.
  </div>


      <!-- ðŸŸ§ Metric Tabs (boutons) -->
      <div class="metric-tabs center-tabs">
        <button 
          *ngFor="let metric of ['latency', 'jitter', 'throughput']"
          [ngClass]="{ 'active': selectedMetric === metric }"
          (click)="switchMetric(metric)">
          {{ metric | titlecase }}
        </button>
      </div>

    </div>
    
<!-- ðŸŸ© Charts for each agent -->
<div class="chart-wrapper" *ngIf="agentChartsData?.length > 0">
  <div *ngFor="let chartData of agentChartsData">
    <h3>ðŸŽ¯ Agent {{ chartData.targetId }}</h3>

    <div class="chart-container" *ngIf="selectedMetric === 'latency'">
      <canvas *ngIf="hasValidChartData(chartData.latencyChart); else noLatency"
              baseChart
              [data]="chartData.latencyChart"
              [options]="chartData.latencyChart.options"
              [type]="'line'">
      </canvas>
      <ng-template #noLatency>
        <div class="no-data-message">No latency data available</div>
      </ng-template>
    </div>

    <div class="chart-container" *ngIf="selectedMetric === 'jitter'">
      <canvas *ngIf="hasValidChartData(chartData.jitterChart); else noJitter"
              baseChart
              [data]="chartData.jitterChart"
              [options]="chartData.jitterChart.options"
              [type]="'line'">
      </canvas>
      <ng-template #noJitter>
        <div class="no-data-message">No jitter data available</div>
      </ng-template>
    </div>

    <div class="chart-container" *ngIf="selectedMetric === 'throughput'">
      <canvas *ngIf="hasValidChartData(chartData.throughputChart); else noThroughput"
              baseChart
              [data]="chartData.throughputChart"
              [options]="chartData.throughputChart.options"
              [type]="'line'">
      </canvas>
      <ng-template #noThroughput>
        <div class="no-data-message">No throughput data available</div>
      </ng-template>
    </div>
  </div>
</div>
